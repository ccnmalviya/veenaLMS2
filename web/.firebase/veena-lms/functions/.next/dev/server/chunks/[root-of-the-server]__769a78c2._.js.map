{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 76, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/yogeshmalvi/Downloads/Telegram%20Desktop/LMS%2BEcommerce/web/src/app/api/s3-signed-url/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\";\nimport { S3Client, GetObjectCommand } from \"@aws-sdk/client-s3\";\nimport { getSignedUrl } from \"@aws-sdk/s3-request-presigner\";\n\nconst AWS_REGION = process.env.AWS_REGION || \"us-east-1\";\nconst AWS_ACCESS_KEY_ID = process.env.AWS_ACCESS_KEY_ID;\nconst AWS_SECRET_ACCESS_KEY = process.env.AWS_SECRET_ACCESS_KEY;\nconst BUCKET_NAME = process.env.AWS_S3_BUCKET_NAME;\n\nif (!AWS_ACCESS_KEY_ID || !AWS_SECRET_ACCESS_KEY || !BUCKET_NAME) {\n  console.error(\"Missing AWS credentials or bucket name\");\n}\n\nconst s3Client = new S3Client({\n  region: AWS_REGION,\n  credentials: {\n    accessKeyId: AWS_ACCESS_KEY_ID || \"\",\n    secretAccessKey: AWS_SECRET_ACCESS_KEY || \"\",\n  },\n});\n\nexport async function GET(request: NextRequest) {\n  try {\n    // Check if credentials are configured\n    if (!AWS_ACCESS_KEY_ID || !AWS_SECRET_ACCESS_KEY) {\n      return NextResponse.json(\n        { error: \"AWS credentials not configured\" },\n        { status: 500 }\n      );\n    }\n\n    if (!BUCKET_NAME) {\n      return NextResponse.json(\n        { error: \"S3 bucket name not configured\" },\n        { status: 500 }\n      );\n    }\n\n    const searchParams = request.nextUrl.searchParams;\n    const key = searchParams.get(\"key\");\n\n    if (!key) {\n      return NextResponse.json(\n        { error: \"Missing 'key' parameter\" },\n        { status: 400 }\n      );\n    }\n\n    // Extract the key from the full URL if provided\n    let objectKey = key;\n    \n    // Handle different URL formats\n    if (key.startsWith(\"https://\") || key.startsWith(\"http://\")) {\n      try {\n        const url = new URL(key);\n        // Remove leading slash from pathname\n        objectKey = url.pathname.substring(1);\n        \n        // If pathname is empty or just \"/\", try to extract from hostname\n        if (!objectKey && url.hostname.includes(BUCKET_NAME || \"\")) {\n          // This shouldn't happen, but handle it\n          objectKey = key.split(`${BUCKET_NAME}/`)[1] || key;\n        }\n      } catch (e) {\n        // If URL parsing fails, try to extract manually\n        if (BUCKET_NAME && key.includes(BUCKET_NAME)) {\n          const urlParts = key.split(`${BUCKET_NAME}/`);\n          objectKey = urlParts[1] || key;\n        } else {\n          objectKey = key;\n        }\n      }\n    } else if (BUCKET_NAME && key.includes(BUCKET_NAME)) {\n      // If bucket name is in the key string, extract the path part\n      const urlParts = key.split(`${BUCKET_NAME}/`);\n      objectKey = urlParts[1] || key;\n    }\n    \n    // Clean up the object key (remove any query parameters)\n    if (objectKey.includes(\"?\")) {\n      objectKey = objectKey.split(\"?\")[0];\n    }\n\n    console.log(\"Generating signed URL for:\", { originalKey: key, objectKey, bucket: BUCKET_NAME });\n\n    const command = new GetObjectCommand({\n      Bucket: BUCKET_NAME,\n      Key: objectKey,\n    });\n\n    // Generate a signed URL that expires in 1 hour\n    const signedUrl = await getSignedUrl(s3Client, command, {\n      expiresIn: 3600, // 1 hour\n    });\n\n    return NextResponse.json({ url: signedUrl });\n  } catch (error: any) {\n    console.error(\"Error generating signed URL:\", {\n      message: error.message,\n      name: error.name,\n      code: error.Code || error.code,\n      bucket: BUCKET_NAME,\n      region: AWS_REGION,\n    });\n\n    // Provide more specific error messages\n    let errorMessage = error.message || \"Failed to generate signed URL\";\n    if (error.name === \"AccessDenied\" || error.Code === \"AccessDenied\" || error.$metadata?.httpStatusCode === 403) {\n      errorMessage = `Access Denied. IAM user needs s3:GetObject permission. Check:\\n1. IAM user has s3:GetObject permission\\n2. Bucket policy allows GetObject (if using bucket policy)\\n3. KMS permissions for encrypted objects`;\n    } else if (error.name === \"NoSuchKey\" || error.Code === \"NoSuchKey\") {\n      errorMessage = `Object not found. The image may not exist at the specified path.`;\n    }\n\n    return NextResponse.json(\n      { error: errorMessage },\n      { status: 500 }\n    );\n  }\n}\n\n\n\n"],"names":[],"mappings":"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"}}]
}